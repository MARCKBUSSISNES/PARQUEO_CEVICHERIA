<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema de Gestión de Parqueo - Marck Business</title>

<!-- jsPDF y html2canvas para generar PDF en cliente -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    :root{
        --bg: #f4f6f8;
        --card: #ffffff;
        --accent: #003366;
        --accent2: #ff6600;
        --muted:#666;
    }
    html,body{height:100%;margin:0;font-family:Inter, Arial, sans-serif;background:#e9eef3;}
    /* fondo general usando tu imagen */
    body{
        background: url('images/121212.png') center/cover fixed no-repeat;
    }
    .app {
        max-width:1100px;
        margin:24px auto;
        padding:20px;
        background: rgba(255,255,255,0.9);
        border-radius:10px;
        box-shadow:0 10px 30px rgba(0,0,0,0.12);
    }

    header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header h1{font-size:1.25rem; color:var(--accent); margin:0;}
    header .info { text-align:right; color:var(--muted); font-size:0.9rem; }

    .controls { display:flex; gap:16px; flex-wrap:wrap; margin:18px 0; align-items:center; }
    .btn-img {
        width:110px;
        height:110px;
        border-radius:10px;
        border:2px solid rgba(0,0,0,0.06);
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.3));
        transition: transform .12s ease, box-shadow .12s ease;
    }
    .btn-img img{ max-width:80%; max-height:80%; pointer-events:none; }
    .btn-img:hover{ transform: translateY(-4px); box-shadow:0 10px 25px rgba(0,0,0,0.12); }

    .small-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn {
        background:var(--accent);
        color:white;
        padding:10px 14px;
        border-radius:8px;
        border:none;
        cursor:pointer;
        font-weight:600;
    }
    .btn.secondary { background:var(--accent2); }
    .btn.ghost { background:transparent; color:var(--accent); border:1px solid rgba(0,0,0,0.08); }

    .layout { display:grid; grid-template-columns: 1fr 380px; gap:18px; align-items:start; }
    @media(max-width:980px){ .layout{ grid-template-columns:1fr; } }

    /* listado y tarjetas */
    .card {
        background:var(--card);
        padding:14px;
        border-radius:10px;
        box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }

    h2.section-title{ margin:0 0 8px 0; color:var(--accent); font-size:1.05rem; }
    .list { display:flex; flex-direction:column; gap:8px; max-height:420px; overflow:auto; padding-right:6px; }
    .item {
        display:flex; align-items:center; gap:12px;
        padding:8px; border-radius:8px;
        border:1px solid rgba(0,0,0,0.04);
    }
    .symbol { width:44px; height:44px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .symbol.car { background: linear-gradient(90deg,#ffefef,#fff4e8); color:#b33; }
    .symbol.moto { background: linear-gradient(90deg,#effaff,#eef9ff); color:#045; }
    .meta { flex:1; display:flex; flex-direction:column; }
    .meta .code { font-weight:700; color:var(--accent); }
    .meta .time { font-size:0.85rem; color:var(--muted); }

    /* area derecha: control de salida, ventas, respaldo */
    .right .field { margin-bottom:10px; }
    label{ font-size:0.85rem; color:var(--muted); display:block; margin-bottom:6px; }
    input[type="text"]{ width:100%; padding:10px;border-radius:8px;border:1px solid #ddd; }
    .sales-list{ max-height:220px; overflow:auto; display:flex; flex-direction:column; gap:6px; margin-top:8px; }
    .sale-row{ display:flex; justify-content:space-between; padding:8px;border-radius:8px;background:#fafafa;border:1px solid #eee;font-size:0.95rem; }

    /* ticket styling (hidden area for print/pdf) */
    .ticket {
        width: 300px; /* ~80mm (adjustable) */
        padding:10px;
        background:white;
        color:black;
        font-family:monospace, monospace;
        font-size:12px;
        border: 1px solid #ccc;
        margin:10px auto;
        line-height:1.15;
    }
    .ticket .center{ text-align:center; }
    .ticket .big{ font-size:16px; font-weight:700; margin:6px 0; }
    .ticket .sep{ border-top:1px dashed #333; margin:8px 0; }
    .ticket .footer { font-size:11px; margin-top:8px; text-align:center; font-weight:700; }

    /* helper */
    .muted{ color:var(--muted); font-size:0.9rem; }
    .flex { display:flex; gap:8px; align-items:center; }
    .right .controls-compact { display:flex; gap:8px; flex-wrap:wrap; }

    /* print styles (only ticket) */
    @media print {
        body * { visibility: hidden; }
        .printable-ticket, .printable-ticket * { visibility: visible; }
        .printable-ticket { position: absolute; left:0; top:0; }
    }
</style>
</head>
<body>
<div class="app">
    <header>
        <h1>Parqueo — Sistema de Gestión</h1>
        <div class="info">
            <div>Tel: +502 41529411</div>
            <div class="muted">Datos guardados en el equipo (localStorage)</div>
        </div>
    </header>

    <div class="controls">
        <!-- botones con tus imágenes -->
        <div class="btn-img" id="btn-moto" title="Ingresar MOTO">
            <img src="images/moto.png" alt="Moto">
        </div>
        <div class="btn-img" id="btn-carro" title="Ingresar CARRO">
            <img src="images/carro.png" alt="Carro">
        </div>

        <div style="flex:1"></div>

        <div class="small-actions">
            <button class="btn ghost" id="export-json">Exportar respaldo (JSON)</button>
            <button class="btn ghost" id="import-json">Importar respaldo (JSON)</button>
            <button class="btn secondary" id="close-day">Cierre de ventas (PDF y limpiar)</button>
        </div>
    </div>

    <div class="layout">
        <!-- izquierda: listado en tiempo real -->
        <div>
            <div class="card">
                <h2 class="section-title">Vehículos en parqueo</h2>
                <div class="muted" style="margin-bottom:8px">Se muestran los vehículos actualmente dentro</div>
                <div id="vehiclesList" class="list" aria-live="polite"></div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
                <h2 class="section-title">Registro rápido</h2>
                <div class="muted">Últimos movimientos</div>
                <div id="logList" class="list" style="max-height:140px;"></div>
            </div>
        </div>

        <!-- derecha: salida y ventas -->
        <div class="right">
            <div class="card">
                <h2 class="section-title">Retirar vehículo</h2>

                <div class="field">
                    <label for="exitCode">Ingrese código del vehículo</label>
                    <input id="exitCode" type="text" placeholder="Código (ej: 123456)" />
                </div>

                <div class="field flex">
                    <div class="btn-img" id="btn-salida" title="Sacar vehículo">
                        <img src="images/salida.png" alt="Salida">
                    </div>
                    <div style="flex:1">
                        <div class="muted">Tarifas: Moto Q5.00 — Carro Q10.00</div>
                    </div>
                </div>

                <div style="height:12px"></div>
                <h2 class="section-title">Ventas del día</h2>
                <div id="salesSummary" class="sales-list"></div>
                <div style="height:8px"></div>
                <div class="muted">Total acumulado: <strong id="totalAmount">Q0.00</strong></div>
            </div>

            <div style="height:12px"></div>

            <div class="card">
                <h2 class="section-title">Respaldo / restaurar</h2>
                <div class="muted">Descarga o sube un archivo JSON con todo el estado</div>
                <div style="height:8px"></div>
                <button class="btn ghost" id="download-json">Descargar respaldo JSON</button>
                <input id="fileInput" type="file" accept="application/json" style="display:none"/>
            </div>
        </div>
    </div>

    <!-- hidden area used to render printable ticket -->
    <div id="printArea" style="display:none;"></div>
</div>

<script>
/* ---------- Configuración y almacenamiento ---------- */
const STORAGE_KEYS = {
  VEHICLES: 'parking_vehicles_v1',
  SALES: 'parking_sales_v1',
  CODES: 'parking_codes_v1',
  LOGS: 'parking_logs_v1'
};

const TARIFF = { MOTO: 5.00, CARRO: 10.00 };

/* util: obtener objeto desde localStorage */
function load(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch(e) { return fallback; }
}
function save(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

/* inicializar estructuras */
let vehicles = load(STORAGE_KEYS.VEHICLES, []); // {code,type,enteredAt}
let sales = load(STORAGE_KEYS.SALES, []); // {code,type,enteredAt,exitedAt,amount}
let usedCodes = load(STORAGE_KEYS.CODES, []); // array de strings
let logs = load(STORAGE_KEYS.LOGS, []); // lista breve de eventos

/* ---------- UI refs ---------- */
const vehiclesList = document.getElementById('vehiclesList');
const salesSummary = document.getElementById('salesSummary');
const totalAmountEl = document.getElementById('totalAmount');
const logList = document.getElementById('logList');

/* ---------- Código aleatorio único ---------- */
function generateUniqueCode() {
  // Genera un número de 6 dígitos (puedes ajustar longitud)
  // Reintenta si ya existe (seguridad)
  const maxAttempts = 1000;
  for(let i=0;i<maxAttempts;i++){
    const code = Math.floor(100000 + Math.random()*900000).toString(); // 6 dígitos
    if(!usedCodes.includes(code) && !vehicles.find(v=>v.code===code)){
      usedCodes.push(code);
      save(STORAGE_KEYS.CODES, usedCodes);
      return code;
    }
  }
  // Si se agota, genera UUID corto
  let code;
  do {
    code = Date.now().toString().slice(-6) + Math.floor(Math.random()*90).toString();
  } while(usedCodes.includes(code));
  usedCodes.push(code);
  save(STORAGE_KEYS.CODES, usedCodes);
  return code;
}

/* ---------- Helpers de fecha/hora ---------- */
function nowISO(){ return new Date().toISOString(); }
function formatDateTime(iso){
  const d = new Date(iso);
  const date = d.toLocaleDateString();
  const time = d.toLocaleTimeString();
  return `${date} ${time}`;
}

/* ---------- Render UI ---------- */
function renderVehicles(){
  vehiclesList.innerHTML = '';
  if(vehicles.length === 0){
    vehiclesList.innerHTML = '<div class="muted">No hay vehículos en parqueo.</div>';
    return;
  }
  vehicles.slice().reverse().forEach(v=>{
    const div = document.createElement('div');
    div.className = 'item';
    const sym = document.createElement('div');
    sym.className = 'symbol ' + (v.type === 'MOTO' ? 'moto' : 'car');
    sym.innerHTML = (v.type === 'MOTO' ? '🏍' : '🚗');
    const meta = document.createElement('div');
    meta.className = 'meta';
    const code = document.createElement('div'); code.className='code'; code.textContent = v.code + '  —  ' + v.type;
    const time = document.createElement('div'); time.className='time'; time.textContent = formatDateTime(v.enteredAt);
    meta.appendChild(code); meta.appendChild(time);
    div.appendChild(sym); div.appendChild(meta);
    vehiclesList.appendChild(div);
  });
}

function renderSales(){
  salesSummary.innerHTML = '';
  if(sales.length === 0){
    salesSummary.innerHTML = '<div class="muted">No hay ventas registradas.</div>';
  } else {
    sales.forEach(s=>{
      const row = document.createElement('div');
      row.className = 'sale-row';
      const left = document.createElement('div');
      left.innerHTML = `${s.type} • ${s.code}`;
      const right = document.createElement('div');
      right.innerHTML = 'Q' + parseFloat(s.amount).toFixed(2);
      row.appendChild(left); row.appendChild(right);
      salesSummary.appendChild(row);
    });
  }
  const total = sales.reduce((acc,s)=>acc + Number(s.amount), 0);
  totalAmountEl.textContent = 'Q' + total.toFixed(2);
}

function renderLogs(){
  logList.innerHTML = '';
  if(logs.length === 0){ logList.innerHTML = '<div class="muted">Sin movimientos aún.</div>'; return; }
  logs.slice().reverse().forEach(l=>{
    const div = document.createElement('div');
    div.className = 'item';
    const meta = document.createElement('div'); meta.className='meta';
    const code = document.createElement('div'); code.className='code'; code.textContent = l.text;
    const time = document.createElement('div'); time.className='time'; time.textContent = formatDateTime(l.at);
    meta.appendChild(code); meta.appendChild(time);
    div.appendChild(meta);
    logList.appendChild(div);
  });
}

/* ---------- Acciones de ingreso ---------- */
function addVehicle(type){
  const code = generateUniqueCode();
  const entry = { code, type, enteredAt: nowISO() };
  vehicles.push(entry);
  save(STORAGE_KEYS.VEHICLES, vehicles);
  logs.push({ text: `${type} ingresó - ${code}`, at: nowISO() });
  save(STORAGE_KEYS.LOGS, logs);
  renderVehicles(); renderLogs();
  // generar ticket de ingreso (opcional imprimir) - mostramos modal imprimible
  const ticketHTML = buildTicketHTML({ code, type, enteredAt: entry.enteredAt, amount: null, isExit:false });
  openPrintWindow(ticketHTML, true);
}

/* ---------- Salida de vehículo y cobro ---------- */
function removeVehicleByCode(codeInput){
  const code = (codeInput || '').toString().trim();
  if(!code) { alert('Ingresa un código válido.'); return; }
  const idx = vehicles.findIndex(v => v.code === code);
  if(idx === -1){ alert('Código no encontrado o vehículo ya retirado.'); return; }
  const vehicle = vehicles[idx];
  const exitedAt = nowISO();
  const amount = vehicle.type === 'MOTO' ? TARIFF.MOTO : TARIFF.CARRO;
  // crear registro de venta
  const sale = {
    code: vehicle.code,
    type: vehicle.type,
    enteredAt: vehicle.enteredAt,
    exitedAt,
    amount: amount.toFixed(2)
  };
  sales.push(sale);
  save(STORAGE_KEYS.SALES, sales);
  // remover de vehículos
  vehicles.splice(idx,1);
  save(STORAGE_KEYS.VEHICLES, vehicles);
  // registro de log
  logs.push({ text: `${vehicle.type} salido - ${vehicle.code} • Q${amount.toFixed(2)}`, at: nowISO() });
  save(STORAGE_KEYS.LOGS, logs);
  // renderizar y emitir ticket
  renderVehicles(); renderSales(); renderLogs();
  const ticketHTML = buildTicketHTML({...sale, isExit:true});
  openPrintWindow(ticketHTML, false);
}

/* ---------- Construcción HTML de ticket ---------- */
function buildTicketHTML(obj){
  /* obj:
      - code, type, enteredAt, (if exit) exitedAt, amount, isExit (bool)
  */
  const dateIn = formatDateTime(obj.enteredAt);
  const dateOut = obj.exitedAt ? formatDateTime(obj.exitedAt) : '';
  const title = obj.isExit ? 'TICKET DE PAGO' : 'TICKET DE INGRESO';
  const amountLine = obj.isExit ? `<div><strong>Importe: Q${Number(obj.amount).toFixed(2)}</strong></div>` : '';
  // ticket markup
  return `
  <div class="ticket printable-ticket" style="width:300px;">
    <div class="center">
      <div><img src="images/Diseño%20sin%20titulo.png" style="max-width:80px;" alt="logo"></div>
      <div class="big">${title}</div>
    </div>
    <div class="center">${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</div>
    <div class="sep"></div>
    <div>Tipo: ${obj.type}</div>
    <div>Código: ${obj.code}</div>
    <div>Hora ingreso: ${dateIn}</div>
    ${ obj.isExit ? `<div>Hora salida: ${dateOut}</div>` : '' }
    ${ amountLine }
    <div class="sep"></div>
    <div class="center">POR FAVOR NO PIERDA ESTE DOCUMENTO</div>
    <div class="center muted" style="margin-top:8px; font-size:11px;">Powered by Marck Business</div>
  </div>
  `;
}

/* ---------- Imprimir o descargar ticket ---------- */
async function openPrintWindow(htmlContent, autoPrint=true){
  // renderizar a printArea y usar html2canvas -> jsPDF o window.print
  const printContainer = document.getElementById('printArea');
  printContainer.innerHTML = htmlContent;
  // mostrar modal de impresión: abrimos nueva ventana para impresión (mejor compatibilidad)
  const win = window.open('', '_blank', 'width=420,height=800');
  if(!win){ alert('Se bloqueó la apertura de la ventana de impresión. Permite popups.'); return; }
  win.document.write(`
    <html><head><title>Ticket</title>
    <style>
      body{ font-family: monospace; padding:10px; background:#fff; }
      .ticket{ width:300px; margin:0 auto; font-size:12px; line-height:1.2; color:#000; }
      .center{text-align:center;}
      .big{font-weight:700; font-size:14px;}
      .sep{border-top:1px dashed #000; margin:8px 0;}
    </style>
    </head><body>
    ${printContainer.innerHTML}
    </body></html>
  `);
  win.document.close();
  // wait for resources
  win.focus();
  if(autoPrint){
    // give the window a moment to load images
    setTimeout(()=>{ win.print(); /*win.close();*/ }, 600);
  }
}

/* ---------- Cierre de ventas: genera PDF resumen y limpia datos ---------- */
async function closeDayAndExportPDF(){
  if(!confirm('El cierre imprimirá y descargará un respaldo en PDF y BORRARÁ los datos actuales. ¿Deseas continuar?')) return;
  // construir contenido del resumen
  const date = new Date().toLocaleString();
  const total = sales.reduce((acc,s)=>acc + Number(s.amount),0);
  const countMoto = sales.filter(s=>s.type==='MOTO').length;
  const countCar = sales.filter(s=>s.type==='CARRO').length;

  // crear HTML de resumen (simple)
  const html = `
    <div style="padding:16px; font-family:Arial;">
      <h2>Resumen de ventas - ${date}</h2>
      <p>Vehículos vendidos: Carros: <strong>${countCar}</strong> — Motos: <strong>${countMoto}</strong></p>
      <p>Total vendido: <strong>Q${total.toFixed(2)}</strong></p>
      <hr/>
      <h3>Detalle de ventas</h3>
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr><th style="text-align:left; padding:6px; border-bottom:1px solid #ccc;">Código</th>
              <th style="text-align:left; padding:6px; border-bottom:1px solid #ccc;">Tipo</th>
              <th style="text-align:left; padding:6px; border-bottom:1px solid #ccc;">Entrada</th>
              <th style="text-align:left; padding:6px; border-bottom:1px solid #ccc;">Salida</th>
              <th style="text-align:right; padding:6px; border-bottom:1px solid #ccc;">Importe</th>
          </tr>
        </thead>
        <tbody>
          ${sales.map(s=>`<tr>
            <td style="padding:6px; border-bottom:1px dashed #eee;">${s.code}</td>
            <td style="padding:6px; border-bottom:1px dashed #eee;">${s.type}</td>
            <td style="padding:6px; border-bottom:1px dashed #eee;">${formatDateTime(s.enteredAt)}</td>
            <td style="padding:6px; border-bottom:1px dashed #eee;">${formatDateTime(s.exitedAt)}</td>
            <td style="padding:6px; border-bottom:1px dashed #eee; text-align:right;">Q${Number(s.amount).toFixed(2)}</td>
          </tr>`).join('')}
        </tbody>
      </table>

      <p style="margin-top:12px; font-weight:700;">POR FAVOR NO PIERDA ESTE DOCUMENTO</p>
    </div>
  `;

  // convertir HTML a canvas con html2canvas y luego a PDF con jsPDF
  const wrapper = document.createElement('div');
  wrapper.style.width = '600px';
  wrapper.innerHTML = html;
  document.body.appendChild(wrapper);

  try {
    const canvas = await html2canvas(wrapper, { scale:2 });
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    pdf.addImage(imgData, 'PNG', 20, 20, pdfWidth-40, pdfHeight);
    // descargar con nombre con fecha
    const filename = `CierreVentas_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;
    pdf.save(filename);
    alert('Cierre exportado como PDF: ' + filename);
  } catch(e){
    console.error(e);
    alert('Error al generar PDF. Asegúrate de permitir popups y recarga la página.');
  } finally {
    document.body.removeChild(wrapper);
  }

  // limpiar datos (única forma de borrar)
  localStorage.removeItem(STORAGE_KEYS.VEHICLES);
  localStorage.removeItem(STORAGE_KEYS.SALES);
  localStorage.removeItem(STORAGE_KEYS.CODES);
  localStorage.removeItem(STORAGE_KEYS.LOGS);
  // refrescar en memoria
  vehicles = []; sales = []; usedCodes = []; logs = [];
  renderVehicles(); renderSales(); renderLogs();
}

/* ---------- Exportar / Importar JSON (respaldo manual) ---------- */
function exportJSON(){
  const all = {
    vehicles, sales, usedCodes, logs, exportedAt: nowISO()
  };
  const blob = new Blob([JSON.stringify(all, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `respaldo_parqueo_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importJSON(file){
  const reader = new FileReader();
  reader.onload = function(e){
    try {
      const obj = JSON.parse(e.target.result);
      if(obj && (obj.vehicles || obj.sales)){
        // Sobrescribir estado actual
        vehicles = obj.vehicles || [];
        sales = obj.sales || [];
        usedCodes = obj.usedCodes || [];
        logs = obj.logs || [];
        save(STORAGE_KEYS.VEHICLES, vehicles);
        save(STORAGE_KEYS.SALES, sales);
        save(STORAGE_KEYS.CODES, usedCodes);
        save(STORAGE_KEYS.LOGS, logs);
        renderVehicles(); renderSales(); renderLogs();
        alert('Respaldo importado correctamente.');
      } else {
        alert('Archivo JSON no válido.');
      }
    } catch(err){
      alert('Error al leer JSON: ' + err.message);
    }
  };
  reader.readAsText(file);
}

/* ---------- eventos UI ---------- */
document.getElementById('btn-moto').addEventListener('click', ()=> addVehicle('MOTO'));
document.getElementById('btn-carro').addEventListener('click', ()=> addVehicle('CARRO'));

document.getElementById('btn-salida').addEventListener('click', ()=>{
  const code = document.getElementById('exitCode').value.trim();
  removeVehicleByCode(code);
  document.getElementById('exitCode').value = '';
});

document.getElementById('close-day').addEventListener('click', closeDayAndExportPDF);
document.getElementById('download-json').addEventListener('click', exportJSON);
document.getElementById('export-json').addEventListener('click', exportJSON);
document.getElementById('import-json').addEventListener('click', ()=> document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change', (e)=> {
  const f = e.target.files[0];
  if(f) importJSON(f);
});

/* ---------- inicilizar UI ---------- */
renderVehicles();
renderSales();
renderLogs();

/* Nota: se mantienen códigos usados en usedCodes para no repetir aun si se hace cierre parcial.
   El cierre completo (closeDayAndExportPDF) elimina todos los datos — es la única forma de borrar según pediste. */

</script>
</body>
</html>
